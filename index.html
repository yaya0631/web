<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GeoMan ‚Äî Gestion des Dossiers</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #080b10;
  --s1:       #0d1117;
  --s2:       #131923;
  --s3:       #1a2332;
  --s4:       #1f2a3d;
  --b1:       #1e2d42;
  --b2:       #263447;
  --b3:       #2e3f56;
  --text:     #dce8f5;
  --t2:       #8aa0bc;
  --t3:       #4f6480;
  --t4:       #2e3f56;
  --acc:      #1d8aff;
  --acc2:     #0066d6;
  --acc-glow: rgba(29,138,255,0.15);
  --green:    #00d68f;
  --red:      #ff4d6d;
  --orange:   #ff8c42;
  --yellow:   #ffd166;
  --purple:   #9b72ff;
  --teal:     #00c5d4;
  --font:     'Syne', sans-serif;
  --mono:     'DM Mono', monospace;
  --r:        5px;
  --r2:       10px;
  --r3:       16px;
  --sh:  0 4px 24px rgba(0,0,0,0.5);
  --sh2: 0 12px 48px rgba(0,0,0,0.7);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;font-size:13px}

/* HEADER */
#header{background:var(--s1);border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 16px;height:50px;gap:8px;flex-shrink:0;position:relative;z-index:100}
.logo-mark{display:flex;align-items:center;gap:10px;margin-right:16px}
.logo-icon{width:32px;height:32px;background:var(--acc);border-radius:var(--r);display:grid;place-items:center;font-size:16px;box-shadow:0 0 12px var(--acc-glow)}
.logo-text{font-size:17px;font-weight:800;letter-spacing:-0.02em}
.logo-text span{color:var(--acc)}
.hbtn{padding:6px 13px;border-radius:var(--r);font-family:var(--font);font-size:12.5px;font-weight:600;cursor:pointer;border:none;display:flex;align-items:center;gap:6px;transition:all .15s;white-space:nowrap;color:white}
.hbtn:hover{filter:brightness(1.2);transform:translateY(-1px)}
.hbtn:active{transform:scale(.97) translateY(0)}
.hb-new  {background:var(--green);color:#001a0f}
.hb-edit {background:var(--acc)}
.hb-del  {background:var(--red)}
.hb-file {background:var(--s3);border:1px solid var(--b2);color:var(--t2)}
.hb-pay  {background:var(--purple)}
.hb-arch {background:var(--orange)}
.hb-ghost{background:transparent;border:1px solid var(--b2);color:var(--t2)}
.hb-ghost:hover{border-color:var(--b3);color:var(--text);background:var(--s3)}
.hsep{width:1px;height:22px;background:var(--b1);margin:0 4px}
.h-right{margin-left:auto;display:flex;align-items:center;gap:6px}
#sb-status{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--t3);font-family:var(--mono)}
.sb-dot{width:7px;height:7px;border-radius:50%;background:var(--t4);transition:background .3s}
.sb-dot.ok{background:var(--green);box-shadow:0 0 6px var(--green)}
.sb-dot.err{background:var(--red)}

/* FILTERBAR */
#filterbar{background:var(--s1);border-bottom:1px solid var(--b1);padding:7px 16px;display:flex;align-items:center;gap:10px;flex-shrink:0;flex-wrap:wrap}
.fl{font-size:11px;color:var(--t3);font-weight:600;text-transform:uppercase;letter-spacing:.06em;white-space:nowrap}
.fi,.fs{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);color:var(--text);font-family:var(--font);font-size:12.5px;padding:5px 10px;outline:none;transition:border-color .15s}
.fi{width:210px}
.fi::placeholder{color:var(--t3)}
.fi:focus,.fs:focus{border-color:var(--acc);box-shadow:0 0 0 2px var(--acc-glow)}
.fs{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%234f6480'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:26px;cursor:pointer}
.fs option{background:var(--s2)}
.chkw{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--t2)}
.chkw input{accent-color:var(--acc);cursor:pointer}
.solde-btn{background:none;border:1px solid var(--b2);border-radius:var(--r);padding:5px 11px;font-family:var(--font);font-size:12px;font-weight:600;color:var(--yellow);cursor:pointer;transition:all .15s}
.solde-btn.active{background:rgba(255,209,102,.1);border-color:var(--yellow)}
.reset-btn{background:none;border:1px solid var(--b1);border-radius:var(--r);padding:5px 11px;font-family:var(--font);font-size:12px;color:var(--t3);cursor:pointer;transition:all .15s;margin-left:auto}
.reset-btn:hover{color:var(--text);border-color:var(--b3)}

/* CONTENT */
#content{display:flex;flex:1;overflow:hidden}
#table-wrap{flex:1;overflow:auto;position:relative}
#loading-overlay{position:absolute;inset:0;background:rgba(8,11,16,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;z-index:50;backdrop-filter:blur(2px);transition:opacity .3s}
.spinner{width:36px;height:36px;border:3px solid var(--b2);border-top-color:var(--acc);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:13px;color:var(--t2);font-family:var(--mono)}

table{width:100%;border-collapse:collapse;font-size:12.5px}
thead th{background:var(--s2);color:var(--t3);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;padding:9px 10px;text-align:left;border-bottom:2px solid var(--acc2);border-right:1px solid var(--b1);white-space:nowrap;position:sticky;top:0;z-index:10;cursor:pointer;user-select:none;transition:color .15s,background .15s}
thead th:hover{color:var(--text);background:var(--s3)}
thead th.sorted{color:var(--acc)}
.si{margin-left:4px;font-size:9px;opacity:.4}
thead th.sorted .si{opacity:1}
tbody tr{border-bottom:1px solid var(--b1);cursor:pointer;transition:background .1s;animation:rowIn .2s ease both}
@keyframes rowIn{from{opacity:0;transform:translateX(-4px)}to{opacity:1;transform:none}}
tbody tr:hover{background:var(--s2)}
tbody tr.sel{background:var(--s3);outline:1px solid var(--b3) inset}
td{padding:8px 10px;color:var(--t2);border-right:1px solid rgba(30,45,66,.5);white-space:nowrap}
td.td-id{font-family:var(--mono);font-size:12px;color:var(--acc);font-weight:500}
td.td-nom{color:var(--text);font-weight:600}
td.td-amt{font-family:var(--mono);color:var(--green)}
td.td-n{color:var(--t4);font-family:var(--mono);font-size:11px}

.chip{display:inline-flex;align-items:center;gap:4px;padding:2px 9px;border-radius:999px;font-size:11px;font-weight:600;white-space:nowrap}
.c-retard  {background:rgba(255,77,109,.12);color:#ff6b85;border:1px solid rgba(255,77,109,.2)}
.c-echeance{background:rgba(255,209,102,.12);color:#ffd166;border:1px solid rgba(255,209,102,.2)}
.c-partiel {background:rgba(155,114,255,.12);color:#b89fff;border:1px solid rgba(155,114,255,.2)}
.c-termine {background:rgba(0,214,143,.12);color:#00d68f;border:1px solid rgba(0,214,143,.2)}
.c-attente {background:rgba(138,160,188,.08);color:#8aa0bc;border:1px solid rgba(138,160,188,.15)}
.c-bloque  {background:rgba(255,140,66,.12);color:#ff9f6a;border:1px solid rgba(255,140,66,.2)}
.c-archive {background:rgba(79,100,128,.1);color:#4f6480;border:1px solid rgba(79,100,128,.2)}

.empty-state{text-align:center;padding:80px 20px;color:var(--t3)}
.empty-state .ei{font-size:44px;margin-bottom:14px;opacity:.5}
.empty-state .et{font-size:16px;font-weight:700;color:var(--t2);margin-bottom:6px}

/* RIGHT PANEL */
#right-panel{width:200px;flex-shrink:0;background:var(--s1);border-left:1px solid var(--b1);padding:14px 12px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
.rp-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t4);margin-bottom:4px}
.rp-file{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:7px 10px;font-size:12px;color:var(--t2);display:flex;align-items:center;gap:7px;cursor:pointer;transition:border-color .15s;overflow:hidden}
.rp-file:hover{border-color:var(--b3);color:var(--text)}
.rp-file span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.rp-empty{font-size:11.5px;color:var(--t4);font-style:italic}

/* STATUSBAR */
#statusbar{background:var(--s1);border-top:1px solid var(--b1);padding:5px 16px;display:flex;align-items:center;gap:18px;flex-shrink:0;font-size:12px;flex-wrap:wrap}
.sbi{display:flex;align-items:center;gap:5px;color:var(--t3)}
.sbi b{font-family:var(--mono);font-weight:600}
.sbi-att b{color:var(--yellow)}
.sbi-enc b{color:var(--green)}
.sbi-res b{color:var(--red)}
.sbi-ver{margin-left:auto;font-family:var(--mono);font-size:11px;color:var(--t4)}

/* LEGEND */
#legend{background:var(--bg);border-top:1px solid var(--b1);padding:4px 16px;display:flex;align-items:center;gap:14px;flex-shrink:0;flex-wrap:wrap}
.lg-lbl{font-size:10.5px;color:var(--t4);font-weight:600;text-transform:uppercase;letter-spacing:.07em}
.lg{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--t3)}
.lg-d{width:8px;height:8px;border-radius:2px}

/* MODALS */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px);animation:fadeIn .15s ease}
.overlay.open{display:flex}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--s1);border:1px solid var(--b2);border-radius:var(--r3);box-shadow:var(--sh2);width:700px;max-width:96vw;max-height:90vh;overflow-y:auto;animation:modalIn .2s cubic-bezier(.34,1.56,.64,1)}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(8px)}to{opacity:1;transform:none}}
.modal-sm{width:480px}
.modal-xs{width:380px}
.mh{padding:18px 22px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between}
.mh-title{font-size:15px;font-weight:800;letter-spacing:-.01em}
.mh-sub{font-size:12px;color:var(--t3);margin-top:2px}
.mh-close{background:var(--s3);border:none;color:var(--t2);width:28px;height:28px;border-radius:50%;font-size:14px;cursor:pointer;display:grid;place-items:center;transition:all .15s}
.mh-close:hover{background:var(--b2);color:var(--text)}
.mb{padding:20px 22px}
.mf{padding:14px 22px;border-top:1px solid var(--b1);display:flex;justify-content:flex-end;gap:8px}

/* FORM */
.fg{display:flex;flex-direction:column;gap:5px}
.fg-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.fg-full{grid-column:1/-1}
.fl-f{font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.06em}
.fc{background:var(--s2);border:1px solid var(--b2);border-radius:var(--r);color:var(--text);font-family:var(--font);font-size:13px;padding:8px 11px;outline:none;width:100%;transition:border-color .15s,box-shadow .15s}
.fc:focus{border-color:var(--acc);box-shadow:0 0 0 2px var(--acc-glow)}
.fc option{background:var(--s2)}
.check-row{display:flex;gap:18px;flex-wrap:wrap;align-items:center}
.chk-item{display:flex;align-items:center;gap:7px;cursor:pointer;font-size:13px;color:var(--t2)}
.chk-item input{accent-color:var(--acc);width:15px;height:15px;cursor:pointer}
.chk-item:hover{color:var(--text)}

/* DASHBOARD */
.db-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.db-card{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r2);padding:16px;text-align:center;transition:border-color .2s}
.db-card:hover{border-color:var(--b3)}
.db-val{font-family:var(--mono);font-size:20px;font-weight:700;margin-bottom:4px}
.db-lbl{font-size:10.5px;color:var(--t3);text-transform:uppercase;letter-spacing:.07em}
.db-bar{height:4px;border-radius:2px;margin-top:8px;background:var(--b1);overflow:hidden}
.db-bar-fill{height:100%;border-radius:2px;transition:width .6s ease}
.db-sec{margin-bottom:18px}
.db-sec-title{font-size:10.5px;font-weight:700;color:var(--t4);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--b1)}
.db-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--b1);font-size:13px}
.db-row:last-child{border-bottom:none}
.db-row .drl{color:var(--t2)}
.db-row .drv{font-family:var(--mono);font-weight:600}

/* RAPPELS */
.rp-item{display:flex;align-items:flex-start;gap:12px;background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:12px 14px;margin-bottom:8px;transition:border-color .15s}
.rp-item:hover{border-color:var(--b3)}
.rp-icon{font-size:20px;flex-shrink:0}
.rp-content{flex:1}
.rp-name{font-weight:700;font-size:13px}
.rp-detail{font-size:11.5px;color:var(--t3);margin-top:2px}
.rp-badge{font-family:var(--mono);font-size:11px;white-space:nowrap}

/* PAIEMENTS */
.pay-summary{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:14px;margin-bottom:16px}
.pay-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b1);font-size:13px}
.pay-row:last-child{border-bottom:none}
.pay-row .pl{color:var(--t3)}
.pay-row .pv{font-family:var(--mono);font-weight:600}
.pay-progress{height:6px;background:var(--b1);border-radius:3px;overflow:hidden;margin:10px 0}
.pay-progress-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--teal));transition:width .5s ease}
.pay-hist-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--b1);font-size:12.5px}
.pay-hist-item:last-child{border-bottom:none}

/* EXPORT */
.export-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.exp-card{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r2);padding:20px;text-align:center;cursor:pointer;transition:all .2s}
.exp-card:hover{border-color:var(--acc);background:var(--s3);transform:translateY(-2px)}
.exp-icon{font-size:30px;margin-bottom:8px}
.exp-title{font-weight:700;font-size:14px}
.exp-desc{font-size:11.5px;color:var(--t3);margin-top:4px}

/* TOASTS */
#toasts{position:fixed;top:58px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{display:flex;align-items:center;gap:10px;background:var(--s2);border:1px solid var(--b2);border-radius:var(--r);padding:10px 16px;font-size:13px;color:var(--text);box-shadow:var(--sh2);animation:toastIn .25s cubic-bezier(.34,1.56,.64,1);min-width:240px}
.toast.t-ok {border-left:3px solid var(--green)}
.toast.t-err{border-left:3px solid var(--red)}
.toast.t-inf{border-left:3px solid var(--acc)}
@keyframes toastIn{from{opacity:0;transform:translateX(16px) scale(.95)}to{opacity:1;transform:none}}

.conf-icon{font-size:44px;text-align:center;margin-bottom:12px}
.conf-msg{text-align:center;font-size:14px;color:var(--t2);line-height:1.6}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--b2);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--b3)}

@media print{
  #header,#filterbar,#right-panel,#statusbar,#legend,.overlay{display:none!important}
  #table-wrap{overflow:visible}
  body{background:white;color:black}
  table{font-size:11px}
  thead th{background:#eee;color:#333;border-color:#ccc}
  td{color:#333;border-color:#ddd}
}
</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div class="logo-mark">
    <div class="logo-icon">üìê</div>
    <div class="logo-text">Geo<span>Man</span></div>
  </div>
  <button class="hbtn hb-new"   onclick="openNew()">Ôºã Nouveau</button>
  <button class="hbtn hb-edit"  onclick="openEdit()">‚úé Modifier</button>
  <button class="hbtn hb-del"   onclick="confirmDelete()">‚úï Supprimer</button>
  <div class="hsep"></div>
  <button class="hbtn hb-file"  onclick="openFichiers()">üìÅ Fichiers</button>
  <button class="hbtn hb-pay"   onclick="openPaiement()">üí≥ Paiements</button>
  <button class="hbtn hb-arch"  onclick="toggleArchive()">üì¶ Archiver</button>
  <div class="hsep"></div>
  <button class="hbtn hb-ghost" onclick="openDashboard()">üìä Dashboard</button>
  <button class="hbtn hb-ghost" onclick="openRappels()">üîî Rappels</button>
  <button class="hbtn hb-ghost" onclick="openExport()">‚Üë Exporter</button>
  <div class="h-right">
    <div id="sb-status">
      <div class="sb-dot" id="sb-dot"></div>
      <span id="sb-label">Connexion‚Ä¶</span>
    </div>
    <div class="hsep"></div>
    <button class="hbtn hb-ghost" onclick="toggleTheme()" id="theme-btn">‚òÄ Clair</button>
  </div>
</div>

<!-- FILTERBAR -->
<div id="filterbar">
  <span class="fl">Recherche</span>
  <input type="text" class="fi" id="f-search" placeholder="Nom, dossier, endroit‚Ä¶" oninput="applyFilters()">
  <span class="fl">Endroit</span>
  <select class="fs" id="f-endroit" onchange="applyFilters()"><option value="">Tous</option></select>
  <span class="fl">D√©p√¥t CAD</span>
  <select class="fs" id="f-depot" onchange="applyFilters()">
    <option value="">Tous</option>
    <option>D√©pos√©</option>
    <option>Non d√©pos√©</option>
    <option>En cours</option>
  </select>
  <span class="fl">Vue</span>
  <select class="fs" id="f-vue" onchange="applyFilters()">
    <option value="actifs">Actifs</option>
    <option value="archives">Archives</option>
    <option value="tous">Tous</option>
  </select>
  <label class="chkw">
    <input type="checkbox" id="f-showall" onchange="applyFilters()"> Afficher archives
  </label>
  <button class="solde-btn" id="solde-btn" onclick="toggleSolde()">‚òê Solde restant</button>
  <button class="reset-btn" onclick="resetFilters()">‚Ü∫ R√©initialiser</button>
</div>

<!-- MAIN -->
<div id="content">
  <div id="table-wrap">
    <div id="loading-overlay">
      <div class="spinner"></div>
      <div class="loading-text">Connexion Supabase‚Ä¶</div>
    </div>
    <table>
      <thead>
        <tr>
          <th onclick="sortBy('_n')" style="width:38px">N¬∞ <span class="si">‚Üï</span></th>
          <th onclick="sortBy('id')">No Dossier <span class="si">‚Üï</span></th>
          <th onclick="sortBy('nom')">Nom et Pr√©nom <span class="si">‚Üï</span></th>
          <th onclick="sortBy('endroit')">Endroit <span class="si">‚Üï</span></th>
          <th onclick="sortBy('date_finale')">Date Finale <span class="si">‚Üï</span></th>
          <th onclick="sortBy('telephone')">T√©l√©phone <span class="si">‚Üï</span></th>
          <th onclick="sortBy('montant')">Montant <span class="si">‚Üï</span></th>
          <th onclick="sortBy('acte')">Acte <span class="si">‚Üï</span></th>
          <th onclick="sortBy('regul')">Regul <span class="si">‚Üï</span></th>
          <th onclick="sortBy('agricole')">Agricole <span class="si">‚Üï</span></th>
          <th onclick="sortBy('depot_cad')">D√©p√¥t CAD <span class="si">‚Üï</span></th>
          <th onclick="sortBy('depot_domain')">D√©p√¥t Domaine <span class="si">‚Üï</span></th>
          <th onclick="sortBy('date_archive')">Date Archive <span class="si">‚Üï</span></th>
          <th onclick="sortBy('etat')">√âtat <span class="si">‚Üï</span></th>
          <th onclick="sortBy('observations')">Observations <span class="si">‚Üï</span></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div id="empty-state" class="empty-state" style="display:none">
      <div class="ei">üìÇ</div>
      <div class="et">Aucun dossier trouv√©</div>
      <div>Modifiez les filtres ou cr√©ez un nouveau dossier</div>
    </div>
  </div>
  <div id="right-panel">
    <div class="rp-title">Fichiers joints</div>
    <div id="rp-files"><div class="rp-empty">S√©lectionnez un dossier</div></div>
  </div>
</div>

<!-- STATUSBAR -->
<div id="statusbar">
  <div class="sbi"><span id="sb-count">0</span> affich√©(s)</div>
  <div class="sbi">Actifs : <b id="sb-actifs">0</b></div>
  <div class="sbi">Archives : <b id="sb-arch">0</b></div>
  <div class="sbi sbi-att">Attendu : <b id="sb-att">0 DA</b></div>
  <div class="sbi sbi-enc">Encaiss√© : <b id="sb-enc">0 DA</b></div>
  <div class="sbi sbi-res">Reste : <b id="sb-res">0 DA</b></div>
  <div class="sbi-ver">v4.0 ¬∑ Supabase</div>
</div>

<!-- LEGEND -->
<div id="legend">
  <span class="lg-lbl">L√©gende :</span>
  <span class="lg"><span class="lg-d" style="background:#ff4d6d"></span> En retard</span>
  <span class="lg"><span class="lg-d" style="background:#ffd166"></span> √âch√©ance &lt;7j</span>
  <span class="lg"><span class="lg-d" style="background:#9b72ff"></span> Solde partiel</span>
  <span class="lg"><span class="lg-d" style="background:#00d68f"></span> Termin√©</span>
  <span class="lg"><span class="lg-d" style="background:#4f6480"></span> En attente</span>
  <span class="lg"><span class="lg-d" style="background:#ff8c42"></span> Bloqu√©</span>
  <span class="lg"><span class="lg-d" style="background:#2e3f56"></span> Archive</span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- DOSSIER FORM -->
<div class="overlay" id="m-dossier">
  <div class="modal">
    <div class="mh">
      <div>
        <div class="mh-title" id="m-dossier-title">Nouveau Dossier</div>
        <div class="mh-sub" id="m-dossier-sub">Remplissez les informations</div>
      </div>
      <button class="mh-close" onclick="closeModal('m-dossier')">‚úï</button>
    </div>
    <div class="mb">
      <div class="fg-grid">
        <div class="fg"><label class="fl-f">N¬∞ Dossier *</label><input class="fc" id="fd-id" placeholder="ex: 94-2026"></div>
        <div class="fg"><label class="fl-f">Nom et Pr√©nom *</label><input class="fc" id="fd-nom" placeholder="Pr√©nom NOM"></div>
        <div class="fg"><label class="fl-f">T√©l√©phone</label><input class="fc" id="fd-tel" placeholder="0XXXXXXXXX"></div>
        <div class="fg"><label class="fl-f">Endroit</label><input class="fc" id="fd-end" placeholder="AET, Bir el Djir‚Ä¶"></div>
        <div class="fg"><label class="fl-f">Montant Total (DA)</label><input class="fc" type="number" id="fd-mont" placeholder="0" min="0"></div>
        <div class="fg"><label class="fl-f">Montant Encaiss√© (DA)</label><input class="fc" type="number" id="fd-enc" placeholder="0" min="0"></div>
        <div class="fg"><label class="fl-f">Date Finale</label><input class="fc" type="date" id="fd-dfin"></div>
        <div class="fg"><label class="fl-f">Date Archive</label><input class="fc" type="date" id="fd-darch"></div>
        <div class="fg"><label class="fl-f">D√©p√¥t CAD</label>
          <select class="fc" id="fd-dcad"><option>Non d√©pos√©</option><option>D√©pos√©</option><option>En cours</option></select></div>
        <div class="fg"><label class="fl-f">D√©p√¥t Domaine</label>
          <select class="fc" id="fd-ddom"><option>Non d√©pos√©</option><option>D√©pos√©</option><option>En cours</option></select></div>
        <div class="fg"><label class="fl-f">√âtat</label>
          <select class="fc" id="fd-etat">
            <option value="attente">En attente</option>
            <option value="echeance">√âch√©ance &lt; 7j</option>
            <option value="partiel">Solde partiel</option>
            <option value="termine">Termin√©</option>
            <option value="retard">En retard</option>
            <option value="bloque">Bloqu√©</option>
          </select></div>
        <div class="fg"><label class="fl-f">Archiv√©</label>
          <select class="fc" id="fd-arch"><option value="false">Non</option><option value="true">Oui</option></select></div>
        <div class="fg fg-full"><label class="fl-f">Options</label>
          <div class="check-row">
            <label class="chk-item"><input type="checkbox" id="fd-acte"> Acte</label>
            <label class="chk-item"><input type="checkbox" id="fd-regul"> Regul</label>
            <label class="chk-item"><input type="checkbox" id="fd-agri"> Agricole</label>
          </div></div>
        <div class="fg fg-full"><label class="fl-f">Observations</label><input class="fc" id="fd-obs" placeholder="Notes, remarques‚Ä¶"></div>
      </div>
    </div>
    <div class="mf">
      <button class="hbtn hb-ghost" onclick="closeModal('m-dossier')">Annuler</button>
      <button class="hbtn hb-edit" onclick="saveDossier()" id="save-btn">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- FICHIERS -->
<div class="overlay" id="m-fichiers">
  <div class="modal modal-sm">
    <div class="mh">
      <div><div class="mh-title">üìÅ Fichiers Joints</div><div class="mh-sub" id="fich-name">‚Äî</div></div>
      <button class="mh-close" onclick="closeModal('m-fichiers')">‚úï</button>
    </div>
    <div class="mb">
      <label class="hbtn hb-ghost" style="cursor:pointer;margin-bottom:14px;display:inline-flex">
        Ôºã Ajouter des fichiers
        <input type="file" id="file-inp" style="display:none" multiple onchange="addFiles(event)">
      </label>
      <div id="fich-list"></div>
    </div>
    <div class="mf"><button class="hbtn hb-ghost" onclick="closeModal('m-fichiers')">Fermer</button></div>
  </div>
</div>

<!-- PAIEMENT -->
<div class="overlay" id="m-paiement">
  <div class="modal modal-sm">
    <div class="mh">
      <div><div class="mh-title">üí≥ Paiements</div><div class="mh-sub" id="pay-name">‚Äî</div></div>
      <button class="mh-close" onclick="closeModal('m-paiement')">‚úï</button>
    </div>
    <div class="mb">
      <div id="pay-summary" class="pay-summary"></div>
      <div class="fg-grid" style="grid-template-columns:1fr">
        <div class="fg"><label class="fl-f">Montant vers√© (DA) *</label><input class="fc" type="number" id="pay-amt" placeholder="0" min="0"></div>
        <div class="fg"><label class="fl-f">Date</label><input class="fc" type="date" id="pay-date"></div>
        <div class="fg"><label class="fl-f">Remarque</label><input class="fc" id="pay-note" placeholder="Optionnel‚Ä¶"></div>
      </div>
      <div id="pay-hist" style="margin-top:16px"></div>
    </div>
    <div class="mf">
      <button class="hbtn hb-ghost" onclick="closeModal('m-paiement')">Fermer</button>
      <button class="hbtn hb-pay" onclick="savePaiement()">Ôºã Ajouter versement</button>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="overlay" id="m-dashboard">
  <div class="modal" style="width:720px">
    <div class="mh">
      <div><div class="mh-title">üìä Tableau de Bord</div><div class="mh-sub" id="db-date">‚Äî</div></div>
      <button class="mh-close" onclick="closeModal('m-dashboard')">‚úï</button>
    </div>
    <div class="mb" id="db-body"></div>
    <div class="mf"><button class="hbtn hb-ghost" onclick="closeModal('m-dashboard')">Fermer</button></div>
  </div>
</div>

<!-- RAPPELS -->
<div class="overlay" id="m-rappels">
  <div class="modal modal-sm">
    <div class="mh">
      <div class="mh-title">üîî Rappels &amp; Alertes</div>
      <button class="mh-close" onclick="closeModal('m-rappels')">‚úï</button>
    </div>
    <div class="mb" id="rappels-body"></div>
    <div class="mf"><button class="hbtn hb-ghost" onclick="closeModal('m-rappels')">Fermer</button></div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div class="overlay" id="m-confirm">
  <div class="modal modal-xs">
    <div class="mb" style="padding:28px 22px">
      <div class="conf-icon">‚ö†Ô∏è</div>
      <p class="conf-msg">Supprimer le dossier<br><strong id="conf-name" style="color:var(--text)"></strong> ?<br><br><small style="color:var(--t4)">Cette action est irr√©versible.</small></p>
    </div>
    <div class="mf">
      <button class="hbtn hb-ghost" onclick="closeModal('m-confirm')">Annuler</button>
      <button class="hbtn hb-del" onclick="doDelete()">üóë Supprimer</button>
    </div>
  </div>
</div>

<!-- EXPORT -->
<div class="overlay" id="m-export">
  <div class="modal modal-sm">
    <div class="mh">
      <div class="mh-title">‚Üë Exporter les Donn√©es</div>
      <button class="mh-close" onclick="closeModal('m-export')">‚úï</button>
    </div>
    <div class="mb">
      <div class="export-grid">
        <div class="exp-card" onclick="exportJSON()"><div class="exp-icon">üìÑ</div><div class="exp-title">JSON</div><div class="exp-desc">Sauvegarde compl√®te r√©importable</div></div>
        <div class="exp-card" onclick="exportCSV()"><div class="exp-icon">üìä</div><div class="exp-title">CSV</div><div class="exp-desc">Compatible Excel / Google Sheets</div></div>
        <div class="exp-card" onclick="window.print()"><div class="exp-icon">üñ®Ô∏è</div><div class="exp-title">Imprimer</div><div class="exp-desc">Impression ou export PDF</div></div>
        <div class="exp-card" onclick="importData()"><div class="exp-icon">üì•</div><div class="exp-title">Importer JSON</div><div class="exp-desc">Restaurer une sauvegarde</div></div>
      </div>
    </div>
    <div class="mf"><button class="hbtn hb-ghost" onclick="closeModal('m-export')">Fermer</button></div>
  </div>
</div>

<div id="toasts"></div>
<input type="file" id="import-inp" accept=".json" style="display:none" onchange="doImport(event)">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUPABASE + APP LOGIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPA_URL = 'https://vlvaolzoorrllqrkknxh.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsdmFvbHpvb3JybGxxcmtrbnhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNzg1NTksImV4cCI6MjA4NzY1NDU1OX0.p2k3L0jd421ns8te6X8a6bR333QkMnFjqp-NO7gsCrE';

const { createClient } = supabase;
const db = createClient(SUPA_URL, SUPA_KEY);
const TABLE = 'dossiers';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let rows      = [];   // full dataset from Supabase
let selId     = null; // selected dossier id (text PK)
let editingId = null; // id being edited
let sortField = 'id';
let sortAsc   = true;
let showSolde = false;
let darkMode  = true;

// ‚îÄ‚îÄ SUPABASE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchAll() {
  const { data, error } = await db.from(TABLE).select('*').order('created_at', { ascending: true });
  if (error) throw error;
  return data;
}

async function upsertRow(row) {
  const { error } = await db.from(TABLE).upsert(row, { onConflict: 'id' });
  if (error) throw error;
}

async function updateRow(id, patch) {
  patch.updated_at = new Date().toISOString();
  const { error } = await db.from(TABLE).update(patch).eq('id', id);
  if (error) throw error;
}

async function deleteRow(id) {
  const { error } = await db.from(TABLE).delete().eq('id', id);
  if (error) throw error;
}

// ‚îÄ‚îÄ REALTIME SUBSCRIPTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function subscribeRealtime() {
  db.channel('dossiers-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: TABLE }, () => {
      loadData();
    })
    .subscribe();
}

async function loadData() {
  try {
    rows = await fetchAll();
    setStatus(true);
    hideLoading();
    render();
  } catch (e) {
    setStatus(false);
    hideLoading();
    toast('err', 'Erreur Supabase : ' + e.message);
  }
}

function setStatus(ok) {
  document.getElementById('sb-dot').className   = 'sb-dot ' + (ok ? 'ok' : 'err');
  document.getElementById('sb-label').textContent = ok ? 'Connect√©' : 'Erreur';
}

function hideLoading() {
  const el = document.getElementById('loading-overlay');
  el.style.opacity = '0';
  setTimeout(() => el.style.display = 'none', 300);
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getFiltered() {
  const search = document.getElementById('f-search').value.toLowerCase();
  const fEnd   = document.getElementById('f-endroit').value;
  const fDep   = document.getElementById('f-depot').value;
  const fVue   = document.getElementById('f-vue').value;
  const fAll   = document.getElementById('f-showall').checked;

  return rows.filter(d => {
    if (fVue === 'actifs'   && d.archive && !fAll) return false;
    if (fVue === 'archives' && !d.archive) return false;
    if (fEnd && d.endroit !== fEnd) return false;
    if (fDep && d.depot_cad !== fDep) return false;
    if (search && !(
      (d.id||'').toLowerCase().includes(search) ||
      (d.nom||'').toLowerCase().includes(search) ||
      (d.endroit||'').toLowerCase().includes(search) ||
      (d.telephone||'').includes(search)
    )) return false;
    return true;
  }).sort((a, b) => {
    let va = a[sortField] ?? '', vb = b[sortField] ?? '';
    if (typeof va === 'boolean') { va = va?1:0; vb = vb?1:0; }
    if (['montant','encaisse'].includes(sortField)) { va = +va||0; vb = +vb||0; }
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ?  1 : -1;
    return 0;
  });
}

function render() {
  const list  = getFiltered();
  const tbody = document.getElementById('tbody');
  const empty = document.getElementById('empty-state');

  if (!list.length) {
    tbody.innerHTML = '';
    empty.style.display = '';
  } else {
    empty.style.display = 'none';
    tbody.innerHTML = list.map((d, i) => {
      const reste = (d.montant||0) - (d.encaisse||0);
      const amtDisplay = showSolde
        ? `<span style="color:var(--yellow)">${fmt(reste)}</span>`
        : fmt(d.montant||0);
      return `<tr class="${d.id===selId?'sel':''}" onclick="selectRow('${d.id}')" ondblclick="openEdit()">
        <td class="td-n">${i+1}</td>
        <td class="td-id">${d.id||''}</td>
        <td class="td-nom">${d.nom||''}</td>
        <td>${d.endroit||'‚Äî'}</td>
        <td style="font-family:var(--mono);font-size:12px">${d.date_finale||'‚Äî'}</td>
        <td style="font-family:var(--mono)">${d.telephone||'‚Äî'}</td>
        <td class="td-amt">${amtDisplay} D</td>
        <td>${boolCell(d.acte)}</td>
        <td>${boolCell(d.regul)}</td>
        <td>${boolCell(d.agricole)}</td>
        <td>${depotChip(d.depot_cad)}</td>
        <td>${depotChip(d.depot_domain)}</td>
        <td style="font-family:var(--mono);font-size:12px">${d.date_archive||'‚Äî'}</td>
        <td>${etatChip(d.etat)}</td>
        <td style="color:var(--t3);max-width:140px;overflow:hidden;text-overflow:ellipsis">${d.observations||'‚Äî'}</td>
      </tr>`;
    }).join('');
  }

  updateStats(list);
  updateEndroitFilter();
  updateRightPanel();
  document.getElementById('sb-count').textContent = list.length;
}

function boolCell(v) {
  return v ? '<span style="color:var(--green);font-weight:700">Oui</span>'
           : '<span style="color:var(--t4)">‚Äî</span>';
}
function depotChip(v) {
  if (v === 'D√©pos√©')   return '<span class="chip c-termine">‚úì D√©pos√©</span>';
  if (v === 'En cours') return '<span class="chip c-echeance">‚ãØ En cours</span>';
  return '<span class="chip c-attente">Non d√©pos√©</span>';
}
function etatChip(e) {
  const m = {
    retard:  ['c-retard',  '‚¨§ En retard'],
    echeance:['c-echeance','‚è≥ √âch√©ance <7j'],
    partiel: ['c-partiel', '‚óë Solde partiel'],
    termine: ['c-termine', '‚úì Termin√©'],
    attente: ['c-attente', '‚óã En attente'],
    bloque:  ['c-bloque',  '‚úï Bloqu√©'],
    archive: ['c-archive', '‚Üì Archive'],
  };
  const [cls, lbl] = m[e] || ['c-attente', '‚Äî'];
  return `<span class="chip ${cls}">${lbl}</span>`;
}
function fmt(v) {
  return Number(v).toLocaleString('fr-DZ', { minimumFractionDigits:2, maximumFractionDigits:2 });
}

function updateStats() {
  const actifs = rows.filter(d => !d.archive).length;
  const arch   = rows.filter(d =>  d.archive).length;
  const att    = rows.reduce((s,d) => s+(d.montant||0), 0);
  const enc    = rows.reduce((s,d) => s+(d.encaisse||0), 0);
  document.getElementById('sb-actifs').textContent = actifs;
  document.getElementById('sb-arch').textContent   = arch;
  document.getElementById('sb-att').textContent    = fmt(att) + ' DA';
  document.getElementById('sb-enc').textContent    = fmt(enc) + ' DA';
  document.getElementById('sb-res').textContent    = fmt(att - enc) + ' DA';
}

function updateEndroitFilter() {
  const sel = document.getElementById('f-endroit');
  const cur = sel.value;
  const vals = [...new Set(rows.map(d=>d.endroit).filter(Boolean))].sort();
  sel.innerHTML = '<option value="">Tous</option>' + vals.map(v=>`<option ${v===cur?'selected':''}>${v}</option>`).join('');
}

function updateRightPanel() {
  const panel = document.getElementById('rp-files');
  const d = rows.find(x => x.id === selId);
  if (!d)                    { panel.innerHTML = '<div class="rp-empty">S√©lectionnez un dossier</div>'; return; }
  if (!d.fichiers?.length)   { panel.innerHTML = '<div class="rp-empty">Aucun fichier</div>'; return; }
  panel.innerHTML = d.fichiers.map(f =>
    `<div class="rp-file"><span>${fileIcon(f.name)}</span><span>${f.name}</span></div>`
  ).join('');
}

function fileIcon(n) {
  const e = (n.split('.').pop()||'').toLowerCase();
  return {pdf:'üìÑ',jpg:'üñº',jpeg:'üñº',png:'üñº',doc:'üìù',docx:'üìù',xls:'üìä',xlsx:'üìä',zip:'üì¶'}[e]||'üìé';
}

// ‚îÄ‚îÄ INTERACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectRow(id) {
  selId = selId === id ? null : id;
  render();
}

function sortBy(f) {
  if (sortField === f) sortAsc = !sortAsc; else { sortField = f; sortAsc = true; }
  document.querySelectorAll('thead th').forEach(th => th.classList.remove('sorted'));
  render();
}

function applyFilters() { render(); }
function resetFilters() {
  document.getElementById('f-search').value = '';
  document.getElementById('f-endroit').value = '';
  document.getElementById('f-depot').value = '';
  document.getElementById('f-vue').value = 'actifs';
  document.getElementById('f-showall').checked = false;
  showSolde = false;
  const btn = document.getElementById('solde-btn');
  btn.classList.remove('active');
  btn.textContent = '‚òê Solde restant';
  render();
}

function toggleSolde() {
  showSolde = !showSolde;
  const btn = document.getElementById('solde-btn');
  btn.classList.toggle('active', showSolde);
  btn.textContent = (showSolde?'‚òë':'‚òê') + ' Solde restant';
  render();
}

let darkOn = true;
function toggleTheme() {
  darkOn = !darkOn;
  document.getElementById('theme-btn').textContent = darkOn ? '‚òÄ Clair' : 'üåô Sombre';
  const light = {
    '--bg':'#f0f4f8','--s1':'#ffffff','--s2':'#f5f7fb','--s3':'#e8edf5',
    '--b1':'#d1dae8','--b2':'#c0ccdf','--text':'#111827',
    '--t2':'#374151','--t3':'#6b7280','--t4':'#9ca3af'
  };
  Object.entries(darkOn ? {} : light).forEach(([k,v]) =>
    document.documentElement.style.setProperty(k, v)
  );
  if (darkOn) ['--bg','--s1','--s2','--s3','--b1','--b2','--text','--t2','--t3','--t4']
    .forEach(k => document.documentElement.style.removeProperty(k));
}

// ‚îÄ‚îÄ CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openNew() {
  editingId = null;
  document.getElementById('m-dossier-title').textContent = 'Nouveau Dossier';
  document.getElementById('m-dossier-sub').textContent   = 'Remplissez les informations';
  clearForm();
  document.getElementById('fd-dfin').value = todayStr();
  openModal('m-dossier');
}

function openEdit() {
  if (!selId) { toast('err', 'S√©lectionnez un dossier √† modifier.'); return; }
  const d = rows.find(x => x.id === selId);
  if (!d) return;
  editingId = d.id;
  document.getElementById('m-dossier-title').textContent = 'Modifier ‚Äî ' + d.id;
  document.getElementById('m-dossier-sub').textContent   = d.nom;
  document.getElementById('fd-id').value    = d.id||'';
  document.getElementById('fd-nom').value   = d.nom||'';
  document.getElementById('fd-tel').value   = d.telephone||'';
  document.getElementById('fd-end').value   = d.endroit||'';
  document.getElementById('fd-mont').value  = d.montant||0;
  document.getElementById('fd-enc').value   = d.encaisse||0;
  document.getElementById('fd-dfin').value  = d.date_finale||'';
  document.getElementById('fd-darch').value = d.date_archive||'';
  document.getElementById('fd-dcad').value  = d.depot_cad||'Non d√©pos√©';
  document.getElementById('fd-ddom').value  = d.depot_domain||'Non d√©pos√©';
  document.getElementById('fd-etat').value  = d.etat||'attente';
  document.getElementById('fd-arch').value  = d.archive ? 'true' : 'false';
  document.getElementById('fd-acte').checked = !!d.acte;
  document.getElementById('fd-regul').checked = !!d.regul;
  document.getElementById('fd-agri').checked  = !!d.agricole;
  document.getElementById('fd-obs').value   = d.observations||'';
  openModal('m-dossier');
}

function clearForm() {
  ['fd-id','fd-nom','fd-tel','fd-end','fd-obs'].forEach(i => { document.getElementById(i).value=''; });
  ['fd-mont','fd-enc'].forEach(i => { document.getElementById(i).value=0; });
  ['fd-dfin','fd-darch'].forEach(i => { document.getElementById(i).value=''; });
  document.getElementById('fd-dcad').value  = 'Non d√©pos√©';
  document.getElementById('fd-ddom').value  = 'Non d√©pos√©';
  document.getElementById('fd-etat').value  = 'attente';
  document.getElementById('fd-arch').value  = 'false';
  ['fd-acte','fd-regul','fd-agri'].forEach(i => { document.getElementById(i).checked=false; });
}

async function saveDossier() {
  const id  = document.getElementById('fd-id').value.trim();
  const nom = document.getElementById('fd-nom').value.trim();
  if (!id)  { toast('err', 'N¬∞ de dossier obligatoire.'); return; }
  if (!nom) { toast('err', 'Nom obligatoire.'); return; }
  if (!editingId && rows.find(d=>d.id===id)) { toast('err', 'Ce num√©ro existe d√©j√†.'); return; }

  const btn = document.getElementById('save-btn');
  btn.textContent = '‚åõ Enregistrement‚Ä¶'; btn.disabled = true;

  const existing = editingId ? rows.find(d=>d.id===editingId) : null;
  const row = {
    id,
    nom,
    telephone:    document.getElementById('fd-tel').value.trim(),
    endroit:      document.getElementById('fd-end').value.trim(),
    montant:      parseFloat(document.getElementById('fd-mont').value)||0,
    encaisse:     parseFloat(document.getElementById('fd-enc').value)||0,
    date_finale:  document.getElementById('fd-dfin').value  || null,
    date_archive: document.getElementById('fd-darch').value || null,
    depot_cad:    document.getElementById('fd-dcad').value,
    depot_domain: document.getElementById('fd-ddom').value,
    etat:         document.getElementById('fd-etat').value,
    archive:      document.getElementById('fd-arch').value === 'true',
    acte:         document.getElementById('fd-acte').checked,
    regul:        document.getElementById('fd-regul').checked,
    agricole:     document.getElementById('fd-agri').checked,
    observations: document.getElementById('fd-obs').value.trim(),
    paiements:    existing?.paiements || [],
    fichiers:     existing?.fichiers  || [],
    updated_at:   new Date().toISOString(),
  };
  if (!editingId) row.created_at = new Date().toISOString();

  try {
    await upsertRow(row);
    selId = id;
    toast('ok', editingId ? 'Dossier mis √† jour.' : 'Dossier cr√©√©.');
    closeModal('m-dossier');
    await loadData();
  } catch(e) {
    toast('err', 'Erreur : ' + e.message);
  } finally {
    btn.textContent = 'üíæ Enregistrer'; btn.disabled = false;
  }
}

function confirmDelete() {
  if (!selId) { toast('err', 'S√©lectionnez un dossier.'); return; }
  const d = rows.find(x=>x.id===selId);
  document.getElementById('conf-name').textContent = `"${d.id} ‚Äî ${d.nom}"`;
  openModal('m-confirm');
}

async function doDelete() {
  try {
    await deleteRow(selId);
    selId = null;
    closeModal('m-confirm');
    toast('ok', 'Dossier supprim√©.');
    await loadData();
  } catch(e) {
    toast('err', 'Erreur : ' + e.message);
  }
}

async function toggleArchive() {
  if (!selId) { toast('err', 'S√©lectionnez un dossier.'); return; }
  const d = rows.find(x=>x.id===selId);
  const newArch = !d.archive;
  try {
    await updateRow(selId, {
      archive:      newArch,
      etat:         newArch ? 'archive' : 'attente',
      date_archive: newArch ? todayStr() : null
    });
    toast('ok', newArch ? 'Dossier archiv√©.' : 'Dossier restaur√©.');
    await loadData();
  } catch(e) {
    toast('err', 'Erreur : ' + e.message);
  }
}

// ‚îÄ‚îÄ FICHIERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openFichiers() {
  if (!selId) { toast('err', 'S√©lectionnez un dossier.'); return; }
  const d = rows.find(x=>x.id===selId);
  document.getElementById('fich-name').textContent = `${d.id} ‚Äî ${d.nom}`;
  renderFichList(d);
  openModal('m-fichiers');
}

function renderFichList(d) {
  const el = document.getElementById('fich-list');
  if (!d.fichiers?.length) { el.innerHTML='<p style="color:var(--t3);font-size:12.5px">Aucun fichier joint.</p>'; return; }
  el.innerHTML = d.fichiers.map((f,i) =>
    `<div class="rp-file" style="margin-bottom:8px;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:8px;overflow:hidden">
        <span>${fileIcon(f.name)}</span>
        <span style="color:var(--text);font-weight:600;overflow:hidden;text-overflow:ellipsis">${f.name}</span>
        <span style="color:var(--t4);font-size:11px;white-space:nowrap">${f.size||''}</span>
      </div>
      <button onclick="removeFile(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:15px;flex-shrink:0">‚úï</button>
    </div>`
  ).join('');
}

async function addFiles(e) {
  const d = rows.find(x=>x.id===selId); if (!d) return;
  const fichiers = d.fichiers || [];
  Array.from(e.target.files).forEach(f => {
    fichiers.push({ name: f.name, size: `${(f.size/1024).toFixed(1)} KB`, addedAt: todayStr() });
  });
  try {
    await updateRow(selId, { fichiers });
    toast('ok', `${e.target.files.length} fichier(s) ajout√©(s).`);
    await loadData();
    const updated = rows.find(x=>x.id===selId);
    if (updated) renderFichList(updated);
    updateRightPanel();
  } catch(err) { toast('err','Erreur : '+err.message); }
  e.target.value = '';
}

async function removeFile(idx) {
  const d = rows.find(x=>x.id===selId); if (!d) return;
  const fichiers = [...(d.fichiers||[])];
  fichiers.splice(idx, 1);
  try {
    await updateRow(selId, { fichiers });
    await loadData();
    const updated = rows.find(x=>x.id===selId);
    if (updated) renderFichList(updated);
    updateRightPanel();
  } catch(e) { toast('err','Erreur : '+e.message); }
}

// ‚îÄ‚îÄ PAIEMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openPaiement() {
  if (!selId) { toast('err', 'S√©lectionnez un dossier.'); return; }
  const d = rows.find(x=>x.id===selId);
  document.getElementById('pay-name').textContent = `${d.id} ‚Äî ${d.nom}`;
  refreshPayModal(d);
  openModal('m-paiement');
}

function refreshPayModal(d) {
  const enc = d.encaisse||0, tot = d.montant||0, reste = tot-enc;
  const pct = tot > 0 ? Math.min(100,(enc/tot)*100) : 0;
  document.getElementById('pay-summary').innerHTML = `
    <div class="pay-row"><span class="pl">Montant total</span><span class="pv">${fmt(tot)} DA</span></div>
    <div class="pay-row"><span class="pl">Encaiss√©</span><span class="pv" style="color:var(--green)">${fmt(enc)} DA</span></div>
    <div class="pay-row"><span class="pl">Reste</span><span class="pv" style="color:${reste>0?'var(--red)':'var(--green)'}">${fmt(reste)} DA</span></div>
    <div class="pay-progress"><div class="pay-progress-fill" style="width:${pct}%"></div></div>
    <div style="text-align:right;font-size:11px;color:var(--t3);font-family:var(--mono)">${pct.toFixed(1)}% encaiss√©</div>`;
  document.getElementById('pay-date').value = todayStr();
  document.getElementById('pay-amt').value  = '';
  document.getElementById('pay-note').value = '';
  renderPayHist(d);
}

function renderPayHist(d) {
  const el = document.getElementById('pay-hist');
  if (!d.paiements?.length) { el.innerHTML='<p style="color:var(--t4);font-size:12px">Aucun versement.</p>'; return; }
  el.innerHTML = `<div style="font-size:10.5px;font-weight:700;color:var(--t4);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px">Historique</div>`
    + d.paiements.map((p,i) => `
      <div class="pay-hist-item">
        <div>
          <span style="font-family:var(--mono);font-weight:700;color:var(--green)">${fmt(p.montant)} DA</span>
          <span style="color:var(--t3);font-size:11px;margin-left:8px">${p.date||''}</span>
          ${p.note?`<span style="color:var(--t4);font-size:11px;margin-left:6px">‚Äî ${p.note}</span>`:''}
        </div>
        <button onclick="removePaiement(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px">‚úï</button>
      </div>`
    ).join('');
}

async function savePaiement() {
  const d = rows.find(x=>x.id===selId); if (!d) return;
  const amt = parseFloat(document.getElementById('pay-amt').value);
  if (!amt || amt <= 0) { toast('err','Montant invalide.'); return; }
  const paiements = [...(d.paiements||[])];
  paiements.push({ montant:amt, date:document.getElementById('pay-date').value, note:document.getElementById('pay-note').value });
  const encaisse = (d.encaisse||0) + amt;
  const etat = encaisse >= (d.montant||0) ? 'termine' : encaisse > 0 ? 'partiel' : d.etat;
  try {
    await updateRow(selId, { paiements, encaisse, etat });
    toast('ok', `+${fmt(amt)} DA enregistr√©.`);
    await loadData();
    const updated = rows.find(x=>x.id===selId);
    if (updated) refreshPayModal(updated);
  } catch(e) { toast('err','Erreur : '+e.message); }
}

async function removePaiement(idx) {
  const d = rows.find(x=>x.id===selId); if (!d) return;
  const paiements = [...(d.paiements||[])];
  const encaisse  = Math.max(0, (d.encaisse||0) - paiements[idx].montant);
  paiements.splice(idx, 1);
  try {
    await updateRow(selId, { paiements, encaisse });
    await loadData();
    const updated = rows.find(x=>x.id===selId);
    if (updated) refreshPayModal(updated);
  } catch(e) { toast('err','Erreur : '+e.message); }
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDashboard() {
  const total  = rows.length;
  const actifs = rows.filter(d=>!d.archive).length;
  const arch   = rows.filter(d=>d.archive).length;
  const att    = rows.reduce((s,d)=>s+(d.montant||0),0);
  const enc    = rows.reduce((s,d)=>s+(d.encaisse||0),0);
  const pct    = att > 0 ? ((enc/att)*100).toFixed(1) : 0;

  const byEtat = {}, byEnd = {};
  rows.forEach(d => {
    byEtat[d.etat] = (byEtat[d.etat]||0)+1;
    if (d.endroit) byEnd[d.endroit] = (byEnd[d.endroit]||0)+1;
  });

  const today  = new Date();
  const urgent = rows.filter(d => {
    if (!d.date_finale || d.archive) return false;
    const diff = (new Date(d.date_finale)-today)/864e5;
    return diff >= 0 && diff <= 7;
  }).length;

  const etatLabels = {retard:'En retard',echeance:'√âch√©ance <7j',partiel:'Solde partiel',termine:'Termin√©',attente:'En attente',bloque:'Bloqu√©',archive:'Archive'};

  document.getElementById('db-date').textContent =
    new Date().toLocaleDateString('fr-FR', {weekday:'long',year:'numeric',month:'long',day:'numeric'});

  document.getElementById('db-body').innerHTML = `
    <div class="db-grid">
      <div class="db-card"><div class="db-val" style="color:var(--acc)">${total}</div><div class="db-lbl">Total Dossiers</div></div>
      <div class="db-card"><div class="db-val" style="color:var(--green)">${actifs}</div><div class="db-lbl">Actifs</div></div>
      <div class="db-card"><div class="db-val" style="color:var(--orange)">${arch}</div><div class="db-lbl">Archiv√©s</div></div>
      <div class="db-card"><div class="db-val" style="color:var(--yellow)">${fmt(att)}</div><div class="db-lbl">Attendu (DA)</div></div>
      <div class="db-card">
        <div class="db-val" style="color:var(--green)">${fmt(enc)}</div><div class="db-lbl">Encaiss√© (DA)</div>
        <div class="db-bar"><div class="db-bar-fill" style="width:${pct}%;background:var(--green)"></div></div>
      </div>
      <div class="db-card"><div class="db-val" style="color:var(--red)">${fmt(att-enc)}</div><div class="db-lbl">Reste (DA)</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
      <div class="db-sec">
        <div class="db-sec-title">√âtat des dossiers</div>
        ${Object.entries(byEtat).map(([k,v])=>`
          <div class="db-row"><span class="drl">${etatChip(k)}</span><span class="drv" style="color:var(--text)">${v}</span></div>
        `).join('')||'<div style="color:var(--t4)">Aucun dossier</div>'}
      </div>
      <div class="db-sec">
        <div class="db-sec-title">Par endroit &amp; alertes</div>
        ${Object.entries(byEnd).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`
          <div class="db-row"><span class="drl">${k}</span><span class="drv" style="color:var(--acc)">${v}</span></div>
        `).join('')||'<div style="color:var(--t4)">Aucune donn√©e</div>'}
        <div class="db-row" style="margin-top:8px"><span class="drl">üö® Urgent (&lt;7j)</span><span class="drv" style="color:var(--yellow)">${urgent}</span></div>
        <div class="db-row"><span class="drl">üí∞ Taux recouvrement</span><span class="drv" style="color:var(--green)">${pct}%</span></div>
      </div>
    </div>`;
  openModal('m-dashboard');
}

// ‚îÄ‚îÄ RAPPELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openRappels() {
  const today = new Date();
  const items = rows.filter(d=>!d.archive&&d.date_finale).map(d=>{
    const diff = Math.round((new Date(d.date_finale)-today)/864e5);
    return {...d,diff};
  }).sort((a,b)=>a.diff-b.diff);

  const overdue = items.filter(d=>d.diff<0);
  const soon    = items.filter(d=>d.diff>=0&&d.diff<=7);
  const coming  = items.filter(d=>d.diff>7&&d.diff<=30);

  function block(icon, title, list, color) {
    if (!list.length) return '';
    return `<div class="db-sec"><div class="db-sec-title">${icon} ${title} (${list.length})</div>`
      + list.map(d=>`
        <div class="rp-item">
          <div class="rp-icon">${icon}</div>
          <div class="rp-content">
            <div class="rp-name">${d.id} ‚Äî ${d.nom}</div>
            <div class="rp-detail">${d.endroit||''} ${d.observations?'¬∑ '+d.observations:''}</div>
          </div>
          <div class="rp-badge" style="color:${color}">${d.diff<0?Math.abs(d.diff)+'j retard':d.diff===0?"Aujourd'hui":'dans '+d.diff+'j'}</div>
        </div>`
      ).join('')+'</div>';
  }

  document.getElementById('rappels-body').innerHTML =
    block('üî¥','En retard',overdue,'var(--red)') +
    block('üü°','√âch√©ance dans 7 jours',soon,'var(--yellow)') +
    block('üîµ','Prochainement (30j)',coming,'var(--acc)') ||
    '<div style="text-align:center;padding:30px;color:var(--t3)">‚úÖ Aucune alerte pour le moment.</div>';
  openModal('m-rappels');
}

// ‚îÄ‚îÄ EXPORT / IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openExport() { openModal('m-export'); }

function exportJSON() {
  dl(new Blob([JSON.stringify(rows,null,2)],{type:'application/json'}), `geoman-backup-${todayStr()}.json`);
  toast('ok','Sauvegarde JSON t√©l√©charg√©e.');
}

function exportCSV() {
  const H = ['N¬∞ Dossier','Nom','Endroit','T√©l√©phone','Montant','Encaiss√©','Date Finale','D√©p√¥t CAD','D√©p√¥t Domaine','√âtat','Observations'];
  const R = rows.map(d=>[d.id,d.nom,d.endroit,d.telephone,d.montant,d.encaisse,d.date_finale,d.depot_cad,d.depot_domain,d.etat,d.observations]);
  const csv = [H,...R].map(r=>r.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  dl(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}),`geoman-${todayStr()}.csv`);
  toast('ok','Export CSV t√©l√©charg√©.');
}

function importData() { document.getElementById('import-inp').click(); }

async function doImport(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = async (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!Array.isArray(data)) throw new Error('Format invalide');
      let count = 0;
      for (const row of data) {
        row.created_at = row.created_at || new Date().toISOString();
        row.updated_at = new Date().toISOString();
        await upsertRow(row);
        count++;
      }
      toast('ok', `${count} dossiers import√©s.`);
      closeModal('m-export');
      await loadData();
    } catch(err) { toast('err', 'Erreur import : ' + err.message); }
  };
  r.readAsText(f);
  e.target.value = '';
}

function dl(blob, name) {
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
}

// ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.addEventListener('click', e => {
  if (e.target.classList.contains('overlay')) e.target.classList.remove('open');
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.querySelectorAll('.overlay.open').forEach(m=>m.classList.remove('open'));
  if ((e.ctrlKey||e.metaKey) && e.key === 'n') { e.preventDefault(); openNew(); }
  if (e.key === 'Delete' && selId) confirmDelete();
});

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(type, msg) {
  const el = document.createElement('div');
  el.className = `toast t-${type}`;
  el.innerHTML = `<span>${{ok:'‚úÖ',err:'‚ùå',inf:'‚ÑπÔ∏è'}[type]}</span><span>${msg}</span>`;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function todayStr() { return new Date().toISOString().split('T')[0]; }

function checkUrgent() {
  const today = new Date();
  const n = rows.filter(d => !d.archive && d.date_finale && new Date(d.date_finale) < today).length;
  if (n > 0) setTimeout(() => toast('err', `‚ö†Ô∏è ${n} dossier(s) en retard !`), 800);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadData().then(() => {
  subscribeRealtime();
  checkUrgent();
});
</script>
<script type="module">
import { inject } from '@vercel/analytics';
inject();
</script>
</body>
</html>
